<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<title>Omakotitalon sähkönkulutus – Infograafi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  <!-- testi -->
  :root {
    --bg: #0b0e12;
    --fg: #e8eef5;
    --muted: #9fb2c7;
    --accent: #5aa0ff;
    --card: #12161d;
    --ring: rgba(90,160,255,.35);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 40px;
    background: var(--bg);
    color: var(--fg);
    font-family: system-ui, sans-serif;
  }

  h1 {
    font-size: 32px;
    margin-bottom: 20px;
  }

  #updated {
    margin-bottom: 20px;
    color: var(--muted);
  }

  /* KPI GRID */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .kpi {
    background: var(--card);
    padding: 18px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .kpi h3 {
    margin: 0;
    font-size: 15px;
    color: var(--muted);
  }

  .kpi p {
    margin: 9px 0 0;
    font-size: 26px;
    font-weight: 600;
  }

  /* KPI animation */
  .kpi-card {
    opacity: 0;
    transform: translateY(10px);
    animation: cardIn .7s ease forwards;
  }
  .kpi-card:nth-child(1) { animation-delay: .0s; }
  .kpi-card:nth-child(2) { animation-delay: .15s; }
  .kpi-card:nth-child(3) { animation-delay: .30s; }

  @keyframes cardIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* BARCHART */
  .chart-section {
    margin-top: 40px;
  }

  .bar-row {
    display: flex;
    align-items: center;
    margin: 8px 0;
  }

  .bar-label {
    width: 160px;
    color: var(--muted);
    font-size: 14px;
  }

  .bar-track {
    height: 14px;
    background: #1c2330;
    border-radius: 7px;
    flex: 1;
    overflow: hidden;
  }

  .bar-fill {
    height: 14px;
    background: var(--accent);
    width: 0%;
    border-radius: 7px;
    animation: growBar 1.2s ease-out forwards;
  }

  @keyframes growBar {
    from { width: 0%; }
    to   { width: var(--w); }
  }

  /* LINE CHART */
  #linechart {
    margin-top: 60px;
    width: 100%;
    height: 220px;
  }

  .error {
    color: #ff8080;
    margin-top: 20px;
  }
  
.axes .grid {
  stroke: rgba(255,255,255,0.06);
  stroke-width: 1;
}

.axes .tick {
  stroke: rgba(255,255,255,0.18);
  stroke-width: 1;
}

.axis-label {
  fill: rgba(232,239,245,0.6);
  font-size: 11px;
}

</style>
</head>
<body>
  <h1>Omakotitalon sähkönkulutus</h1>
  <div id="updated"></div>

  <!-- KPI GRID -->
  <div class="kpi-grid">
    <div class="kpi kpi-card">
      <h3>Keskiarvo / päivä</h3>
      <p id="avgDay">–</p>
    </div>
    <div class="kpi kpi-card">
      <h3>Peruskuorma</h3>
      <p id="baseLoad">–</p>
    </div>
    <div class="kpi kpi-card">
      <h3>Kulutus (10 pv)</h3>
      <p id="total10">–</p>
    </div>
  </div>

  <!-- DEVICE BARS -->
  <h2 style="margin-top:40px;">Kulutus laitteittain</h2>
  <div id="deviceBars"></div>

  <!-- LINE CHART -->
  <h2 style="margin-top:60px;">Kulutus vuorokaudessa (kWh / h)</h2>
  <svg id="linechart"></svg>

  <div id="error" class="error"></div>

<script>
//
// 1. TRY TO LOAD REAL DATA FIRST
//
async function loadData() {
  try {
    const r = await fetch("data/energy.real.json?ts=" + Date.now());
    if (!r.ok) throw new Error("HTTP " + r.status);

    const txt = await r.text();

    // JSON-validointi: poistetaan trailing-merkit ja tyhjät rivit
    const clean = txt.trim();
    return JSON.parse(clean);
  } catch (e) {
    console.warn("REAL DATA FAILED, using fallback", e);
    document.getElementById("error").textContent =
      "Datan lataus epäonnistui (täytetään esimerkkidatalla).";

    return {
      meta: { generated_at: "–" },
      summary: { base_load_w: 150 },
      daily_kwh: [18.2,16.9,19.4,17.8,20.1,18.6,16.2,17.1,19.0,18.4],
      devices: [
        {name:"Lämmin vesi",kwh:42.5},
        {name:"Keittiö",kwh:18.1},
        {name:"Viihde & TV",kwh:12.6},
        {name:"Työhuone",kwh:10.9},
        {name:"Muut",kwh:9.7}
      ],
      hourly_avg_kwh: [
        0.32,0.30,0.29,0.28,0.30,0.35,
        0.55,0.72,0.60,0.50,0.46,0.44,
        0.45,0.48,0.52,0.58,0.70,0.88,
        0.92,0.80,0.65,0.50,0.40,0.35
      ]
    };
  }
}

//
// 2. RENDER KPI VALUES
//
function renderKPI(data) {
  const avg = data.daily_kwh.length
    ? (data.daily_kwh.reduce((a,b)=>a+b,0) / data.daily_kwh.length).toFixed(1)
    : "0.0";

  document.getElementById("avgDay").textContent = avg + " kWh";
  document.getElementById("baseLoad").textContent = data.summary.base_load_w + " W";

  const total10 = data.daily_kwh.reduce((a,b)=>a+b,0).toFixed(1);
  document.getElementById("total10").textContent = total10 + " kWh";

  document.getElementById("updated").textContent =
    "Data päivitetty: " + (data.meta.generated_at || "–");
}

//
// 3. RENDER DEVICE BARS
//
function renderDeviceBars(devs) {
  const max = Math.max(...devs.map(d => d.kwh));

  const container = document.getElementById("deviceBars");
  container.innerHTML = "";

  devs.forEach(d => {
    const pct = ((d.kwh / max) * 100).toFixed(1) + "%";

    const row = document.createElement("div");
    row.className = "bar-row";
    row.innerHTML = `
      <div class="bar-label">${d.name}</div>
      <div class="bar-track">
        <div class="bar-fill" style="--w:${pct};"></div>
      </div>
      <div style="margin-left:10px;color:var(--muted);width:60px;">${d.kwh.toFixed(1)} kWh</div>
    `;
    container.appendChild(row);
  });
}

//
// 4. RENDER 24H LINE CHART
//
function renderLineChart(arr) {
  const svg = document.getElementById("linechart");
  const W = svg.clientWidth;
  const H = svg.clientHeight;
  const PAD = 32;

  svg.innerHTML = "";
  if (!arr.length) return;

  const max = Math.max(...arr);
  const min = Math.min(...arr);

  const NS = "http://www.w3.org/2000/svg";

  // ===== AXES GROUP =====
  const axes = document.createElementNS(NS, "g");
  axes.setAttribute("class", "axes");

  // Y-axis ticks (0%, 50%, 100%)
  [0, 0.5, 1].forEach(t => {
    const y = PAD + (1 - t) * (H - 2 * PAD);

    const grid = document.createElementNS(NS, "line");
    grid.setAttribute("x1", PAD);
    grid.setAttribute("x2", W - PAD);
    grid.setAttribute("y1", y);
    grid.setAttribute("y2", y);
    grid.setAttribute("class", "grid");
    axes.appendChild(grid);

    const label = document.createElementNS(NS, "text");
    label.setAttribute("x", PAD - 6);
    label.setAttribute("y", y + 4);
    label.setAttribute("text-anchor", "end");
    label.setAttribute("class", "axis-label");
    label.textContent = (max * t).toFixed(1);
    axes.appendChild(label);
  });

  // X-axis ticks (0, 6, 12, 18, 23)
  [0, 6, 12, 18, 23].forEach(h => {
    const x = PAD + (h / 23) * (W - 2 * PAD);

    const tick = document.createElementNS(NS, "line");
    tick.setAttribute("x1", x);
    tick.setAttribute("x2", x);
    tick.setAttribute("y1", H - PAD);
    tick.setAttribute("y2", H - PAD + 6);
    tick.setAttribute("class", "tick");
    axes.appendChild(tick);

    const label = document.createElementNS(NS, "text");
    label.setAttribute("x", x);
    label.setAttribute("y", H - PAD + 18);
    label.setAttribute("text-anchor", "middle");
    label.setAttribute("class", "axis-label");
    label.textContent = String(h).padStart(2, "0");
    axes.appendChild(label);
  });

  svg.appendChild(axes);

  // ===== LINE =====
  const pts = arr.map((v, i) => {
    const x = PAD + (i / (arr.length - 1)) * (W - 2 * PAD);
    const y = PAD + (1 - (v - min) / (max - min + 0.0001)) * (H - 2 * PAD);
    return `${x},${y}`;
  }).join(" ");

  const poly = document.createElementNS(NS, "polyline");
  poly.setAttribute("points", pts);
  poly.setAttribute("stroke", "var(--accent)");
  poly.setAttribute("fill", "none");
  poly.setAttribute("stroke-width", "3");
  poly.style.strokeDasharray = "2000";
  poly.style.strokeDashoffset = "2000";
  poly.style.animation = "draw 2.2s ease forwards";

  svg.appendChild(poly);
}

//
// 5. LINE ANIMATION
//
const style = document.createElement("style");
style.textContent = `
@keyframes draw {
  to { stroke-dashoffset: 0; }
}
`;
document.head.appendChild(style);

//
// 6. MAIN
//
loadData().then(data => {
  renderKPI(data);
  renderDeviceBars(data.devices || []);
  renderLineChart(data.hourly_avg_kwh || []);
});
</script>

</body>
</html>
